accounts = {
    '0x28e73c83c0f85784543300b96a1a3c2e900f7a35': 25748,
    '0xdff0b65b3b40351ea2d2402bac3a51ba179d1a44': 1020,
    '0x24bacee5ba8dc1a0f6f719884044363dbabb30b7': 6011,
    '0xa81ce04168e41a47f68a975d67a00fbef729af9b': 2456,
    '0x0b1413e95202570287f490f6cae04f60ec1018be': 19568,
    '0xb20d42e335f203d4421cab57a543b29ea590e69e': 4217,
    '0xea4683327b308970ce01943acc3244da616eec8f': 73,
    '0xaf4133ef633483dc4ea0d8e591787d800a911e87': 10878,
    '0x83a86d0fe04ef3bc75ba95b06e7c5d22df33c23a': 68,
    '0x99c1c5478b00afc2fc1bd946c7e704ebcf77794d': 1715,
    '0x73d144daace606d3e6ba266f16024f58f750e8c5': 108,
    '0xf6ab3535f6bcd0403919276f3731dff200caf0b8': 95,
    '0x104e6d0dea53f7bc7bb22b0e8633d4ea62d73db7': 4890,
    '0x4fb520ee0a14d8f0c39c5168f3098438cb3dce56': 96,
    '0x4b7536c40074cb9b877c3c46157f5c29140c1c59': 102,
    '0xb80478b000ba07da638c851b9a5536a587a63c62': 1245,
    '0x22a895db1934daf1c12bbcd67c0d7b6647c1d9e5': 557,
    '0x7c00d7b0feaebd9cef86875925ea200cab83eed8': 7,
    '0x5bcb66a3c81892a98907bac60764645530c75d42': 96,
    '0x1045e66149da028a0f625624a878c6b0765712ee': 87,
    '0xf04a8056006daa05ea9067477997e5087d7076fb': 73,
    '0x2103495c64700f1b238a4a1bea9cf60201b50077': 309,
    '0xea8a67728e817eb63b3b794aa3b3a89e8cba475b': 231,
    '0xbd737fdeffc1bd33100781cd8b027860c781849c': 82,
    '0x47195a1ff06914df29d65de40fa9bec8c1d252b1': 358,
    '0xad51824ae0bd74c13eb60cdc20064dc48769119a': 68,
    '0xfb8d472292b47d87d55051c6d6792c1817ea2f9c': 94,
    '0xba863086c93fb97ae74225931995b1206b7fde60': 121,
    '0x8ed42bed5611da447a6bc499312dd3195bac6c91': 127,
    '0x0def7259736f7d6af8a2a59e35ec9b1da7e0c820': 78,
    '0x02d9cb86b413f8d5564b0d224bf34b0428a93ba1': 739,
    '0xc1608327b8f0d389c1024c63246c1c2bb27c529c': 106,
    '0x820ef56b0817edf37353bd5e8bed25f35b310cb3': 108,
    '0xcd85ad2b68dd3d55471098e1ce8917c345764094': 62,
    '0xcf8798bbe7a51051f19b73ce7d99f661196288fe': 90,
    '0xce34375e4e731f1f2ecb7533b8926b4fc6a36951': 129,
    '0x88b20f1462b1ced77e8c867ba8a2e6060fd0d5cb': 135,
    '0x8094c9563a434ec25c9e1450b5f117127a35029b': 119,
    '0xc899ab716f2a04241d60c751141c455745ddef8b': 101,
    '0x1be9b835f34b6d01ad1ab8beb5e40a9c4f160d82': 137,
    '0x1f60fb0ab527471ef9165e14b692a0825e2f97d5': 83,
    '0x5a7ee6c4c92567425a8e9b5a4e32d8074ef15c02': 56,
    '0x139b341c75d016a2df262f9babb4f8c794484d41': 3457,
    '0x10fd6824e54756f609bf08ef223e31c7e4d94e47': 66,
    '0xd6be7bfbf4fd5196da2fb8323e9bfee74b086c07': 69,
    '0xaa2bd5869229a970d097464a4b80b1689e513c05': 100,
    '0x976b13d31c6e3f471251f04546ce31a258a90058': 2,
    '0xa8f53ab772dd9906b06c74889e9b996bf18e3f86': 120,
    '0xc56c0e532ace2942cb3e604127ad24fdb8d1d022': 55,
    '0x5fef5c5a1549c10ea9b911e60db0b834c5df4bbb': 69,
    '0x8cd31b315bfbcb24e046f85ec1d6848b8bf643b4': 80,
    '0xcb4f19335b108cf279c7c46bfa7907794680ed23': 42,
    '0x997fbc11f98dd2a35888b5d0d28c4b81c8e566c1': 130,
    '0x84bcc4fc1a9f26fcc7b159cf27cd57b81f5d5bf8': 68,
    '0x8a8f111b84ea66025f743a1779c89e203f6e0253': 56,
    '0xa153e789d45fc5be2986917a33e298437f52899c': 102,
    '0x383e79486d3ecdcddc85ce59c4aac7f1a6637ae8': 77,
    '0xf7d7112e8d528bcd60734566f637c7e7e2a1e794': 80,
    '0x29ee020c6b9b9092d03ad8f0e1293f936e48e7e3': 92,
    '0xbeb6e0ae5616559663ddc202e6ba00dfdedc098c': 125,
    '0x7d79a87659063e2e63b72c3b0896789473a717c8': 25,
    '0xfb8edc880358260449d33208a4e8c65b319adb9b': 84,
    '0x7eea3d14617914d7fc2a9deb9d851abdf850ea94': 62,
    '0x34de7fa06ad0b7c9de0514fc0cade2476db2c6e0': 114,
    '0x0b78fae7acb84c9bf70b85e78e2985cba19f9155': 56,
    '0x70831901d9d000515491231fb43be1bc0e549ee0': 135,
    '0xab0fdacb3fb80a70f510781df57211be25d8be00': 1,
    '0xf9c4a799627353600905dab119287a3fa1da4c1f': 50,
    '0x52d1780eb9d426e2fb7c1ac76abae85cd207a149': 1,
    '0xf4c288feaaede002fcf548ff5070182db982707d': 77,
    '0x7d9c6e2be54299e6b8c5b256b5d5d458e585b913': 103,
    '0xdcc1f7067064c2d0020eb6da5ca5704c54905ca1': 503,
    '0xcffd05069f618f02e49308a2d906dcb9c65b51c2': 70,
    '0x51d8081e32f628a86cd1b3a50d01d59e879cd4d3': 48,
    '0xfea4ba0d516162f994afa8d6da51f87d4a184993': 58,
    '0x7f46867e7063856aec871befa017d9237853eea3': 73,
    '0xf5fa9ab64e62736a3ae9f6068eac3b7e0a9e62da': 101,
    '0xdae326778dcd31249da66527749d04ce0f63b508': 106,
    '0x353b7a9c1aedad804d0c32daf2373c82bff2bb55': 130,
    '0xba704f21dd900d675941d0a7e2256f029135cbb0': 95,
    '0x1890879c6d9f906d5240227b2c2ce9554865fd0a': 131,
    '0xb757c05e415ed00c923da9908987eaad9c279135': 77,
    '0x7814b8c5920923352bd7b6eab89920c628779d7f': 55,
    '0xcc99954275e155ab5237e27b509a901b8ecf6bb1': 104,
    '0x095a4d1b1fa8cfd4f802bdc31222b4970a815685': 85,
    '0xdbdfc363c5f6cb5a2e9112f9253084327700192c': 63,
    '0x5805536427aa70e55fc2b9ae441f9b5e3267889d': 76,
    '0xd672893f1d5b4c1779ed5a8376abea8081d013ff': 61,
    '0x18214e5691a116995a5b6f6a8a4029bc7574c47a': 122,
    '0xd27cb163f5d253c5750b38ebdfeeb9ca198622f7': 35,
    '0xa4399d9e52135ba39ac219ec3c328f90af270ef4': 94,
    '0x42c8c9df9b563ed81589c31b93938ca51d9c7ed6': 95,
    '0x95bcca2c5cc322e4b6a2d9cd8096cf74b876d4b5': 100,
    '0x65bab4f268286b9005d6053a177948dddc29bad3': 2,
    '0xa0fbc4798822f55ede9fbf0169e187c36aef3b2b': 11,
    '0xdb5b02b58850f916428520f16d0c1eef6f24c29f': 49,
    '0xa3fc8f7cc65736cf2bdc76258b4748c4d6c79d49': 29,
    '0x12a07c77ff485b098fbacce030a783753490a483': 81,
    '0x672b76d2808ef6a8962aa61d95cf4a489ea2c5e5': 92,
    '0x45f8cf8d9c4aa53bfeb1a170bb92b5e2f8db66df': 544,
    '0xde06712a6350fbe1968c6f3e79886393ffbd4bd7': 54,
    '0xf045a0d540f5ce82c0090e08740204878b29c673': 67,
    '0x2976307c3865a9c251e1e0b269ea041a82cb67dc': 93,
    '0xeea430dfe37cfe7bf42b51ca7d066a4c97d66310': 82,
    '0x99ff803fb455e3e26d7ae0e4ef4487a8e52ff724': 5,
    '0x504df711c06b406629a78dce63fb507c95c6d8f6': 82,
    '0xf6a2fac8d2ab8d2b186f575afb156a8849bafd9c': 4,
    '0x33bb2dac6dc2480b3e90fac83cf772a23ac2636b': 21,
    '0xdb6f1920a889355780af7570773609bd8cb1f498': 68,
    '0x13f28ea70d7d1fd35bc53cd257c5c58e103f979a': 79,
    '0xe69a8e4df9bec4e76259704b748f5de074516a70': 84,
    '0xa979701d40c3d4851c49212cca281de3cace49ba': 4,
    '0x2ca930d38be12b65165fcf9a066aad4d777a4e67': 68,
    '0x28fd1d6bb945d0ffac1c243cb222b76f72649938': 8,
    '0xa262f998b3d20ec7315870a014b498423279d1b7': 12,
    '0x98006cd32a5ece634cb70eeff08e56c98a78f7ae': 1,
    '0xb837b1d199b9b911f1e00dae3a93de78f84c9afa': 3284,
    '0xec009815b473459cb8da30f6cf9c6e91c286d7fe': 200,
    '0xc113d3a41dc3af4d62ad0db1e7d366a2587645ee': 188,
    '0xf6dbba9639100c1004d5ba18effd897828f8126d': 123,
    '0xd1757d7c8f42cd3185e41e9361a0bb38c0fcbcea': 41,
    '0xb7c562e33956519255956d73ffe47e4c0af10636': 1,
    '0xd3b21c22703ff33ea9d65e58694299df698f3457': 1,
    '0x20027bd4a6fa91ac183ff62a6230f4e5bf459897': 14,
    '0x380bcf92513c2887f6d293fc97a70ad977205bc5': 38,
    '0x4062d25ea3f53c51ff740739fd490ed52175be7f': 10,
    '0xd75308650d2f4e885051616b7d6122bc305eac9c': 12,
    '0x804ce29aae93007d5c3a83a446f5eaa2ddd5cf28': 48,
    '0xb7a3362ec3f430a2e955a3d7f40913a0ebd4fd87': 1,
    '0x33972ee7b64ad567e8983cdaf70f9581ed50f51c': 8,
    '0xd0f0714fb594a992842189e6091dd8dad68eb48f': 19,
    '0x9869ff7f6173da1df484a71988daa61c9342cfcd': 5,
    '0xae9c553b6a30d0aeb292c1c238325b8cdd878a5c': 30,
    '0xe403b6094d913172f67224490bf9cbecb07e9914': 2,
    '0x7be3ea6382fd87d73a93a790d1ab370723d2fe04': 14,
    '0xccc8decf85816b1ee28b2c46045b3d87bcb0c27b': 13,
    '0x11431a89893025d2a48dca4eddc396f8c8117187': 1,
    '0xfd57917d2d096715dbdeb207c7e1bd8b734874bf': 1,
    '0x9e469be736eb75472819008ef04287bc641f33a2': 3,
    '0xdc9fa56010d125d775f5963d24ed7f1ec4ac6ddd': 3,
    '0xe04349940a1dbe8e87e89c60991472d41108a287': 8,
    '0x2b92c72fca42e8074cb1ef903a84a05a15e620b8': 7,
    '0x125d2e4a83bbba4e6f51a244c494f9a1958d20bb': 10,
    '0x891e17d6f72157b406bde44cdaa0f6e86732dd3d': 348,
    '0x5b0d9f865194e5e29bf17f8b538ed72dcc6bbfff': 3,
    '0x8588b7cecd39527afb1447621ad65c078e3f14de': 3,
    '0x86c3d1803b03fc509eaf7625579e77e4d21aab15': 4,
    '0x5205c6ae35e5fcef0788d269dc97b12d39e689bd': 5,
    '0x07af6ba07bd685fcc424e69e02bebf3a0023a79a': 1,
    '0x4fe169c10f56e2fdf11d8143023af162a5c48b90': 2,
    '0x37dc3edfc1ed7362bc4bacebbf8aac81790d06e9': 1,
    '0xcb159ec438d15c9bec8d0e751d870ecd9167b7b7': 1,
    '0x2ba697b22285b0ce98fc2559c8932b82e79efd93': 7,
    '0xb25004cd77464d59f9aae9a78376d42e13659367': 9,
    '0x8fa9abeca9c3eea824d2d77f5b6c481cba651dd6': 1,
    '0x3cd544310f99128b5b384e70597d0bc554309206': 5,
    '0x8f2a616042c049b565aa51bbefcbfed16a458357': 228,
    '0xfb7f91db3a7e2fa21583a1461983e624903139ff': 1,
    '0xf833f43d961738a3ca659cd7c20ce6772c044418': 6,
    '0x10350047083c96b9c384b492b9214a47ad7e757a': 1,
    '0x0c8c8a3431c444cacc271034b606665ba987e11c': 12,
    '0x37cdf58f084bccf88f949b0790b7c27b85f88ae6': 1517,
    '0x5fedb6700442b4ffdd450744fa95630cf93e9894': 1,
    '0x20d598496ecbaddf665dc265c44ac39c528b8f81': 1,
    '0xb2aebbd0dcd008a1f1bdb2aa48c44f32dcadd1ed': 1,
    '0x44fe2a2536766a85370062d58da24a3a7fb704ac': 1,
    '0x31b2dcfa421118a046901207a8de52e2e9efc686': 1,
    '0xa53dcef55e49959e5663ffd424a1d9a224db207f': 1389,
    '0xb31295c2f36d611e4d85baa65f0781c2b4a88d3c': 5,
    '0xdef171fe48cf0115b1d80b88dc8eab59176fee57': 1,
    '0xe8df83ec1b81dea840fe99b34b57f0702a38c4a6': 1
  }

from web3 import Web3
from web3.middleware import geth_poa_middleware
import asyncio
import aiohttp
import json
from ast import literal_eval

async def _get_tx_receipts(session, endpoint_uri, tx):
    data = {
        "jsonrpc": "2.0",
        "id": "0",
        "method": "eth_getTransactionReceipt",
        "params": [tx.hex()],
    }
    async with session.post(endpoint_uri, json=data) as response:
        if response.status != 200:
            response.raise_for_status()
        return await response.text()

async def _geth_get_tx_receipts(endpoint_uri, transactions):
    # print("getting tx traces")
    # start = time.time()
    geth_tx_receipts = []
    async with aiohttp.ClientSession() as session:
        tasks = [
            asyncio.create_task(_get_tx_receipts(session, endpoint_uri, tx))
            for tx in transactions
        ]
        geth_tx_receipts = await asyncio.gather(*tasks)
    # print("getting tx receipts done ", time.time() - start)
    return [json.loads(tx_receipts) for tx_receipts in geth_tx_receipts]

def geth_get_tx_receipts(base_provider, transactions):
    return asyncio.run(_geth_get_tx_receipts(base_provider.endpoint_uri, transactions))

base_provider = Web3.HTTPProvider("http://94.130.242.196:8545")
base_provider.middlewares.remove("http_retry_request")
w3 = Web3(base_provider)
w3.middleware_onion.inject(geth_poa_middleware, layer=0)

addrs = dict()
start = 20240039
final = 20244139
spammer = 0
n_spammer = 0
for block in range(start, final):
    print("analysing", block, 100*(block-start)/(final-start), "percent done", final-start, "blocks to analyze in total", flush=True)
    block_json = w3.eth.get_block(block, True)
    block_trace = base_provider.make_request("debug_traceBlockByHash", [block_json['hash'].hex(), {"tracer": "callTracer"}])
    # print(block_json['transactions'])
    transactions = [tx['hash'] for tx in block_json['transactions']]
    receipts = geth_get_tx_receipts(base_provider, transactions)
    tx_dict = dict()
    for idx,tx in enumerate(block_json['transactions']):
        net_gas = tx['gas']
        used_gas = literal_eval(receipts[idx]['result']['gasUsed'])
        if net_gas == 0 or float(used_gas)/net_gas < 0.35:
            spammer += 1
        else:
            n_spammer += 1
    print("spammer", spammer, "n_spammer", n_spammer, "percentage", 100*spammer/(spammer+n_spammer), flush=True)
        # tx_dict[tx['hash'].hex()] = {"gas": tx['gas'], ''}
    # for tx in receipts:
    #     res = tx['result']
    #     tx_dict[]
    # print(receipts[0])  
    # results = block_trace['result']
    # for res in results:
    #     if 'result' not in res:
    #         continue
    #     contract = res['result']['to']
    #     if contract in addrs.keys():
    #         addrs[contract] = addrs[contract]+1
    #     else:
    #         addrs[contract] = 1

# spammer = 0
# n_spammer = 0
# for addr in addrs.keys():
#     if addr in accounts.keys():
#         spammer += addrs[addr]
#     else:
#         n_spammer += addrs[addr]
print("---------spammer", spammer, "n_spammer", n_spammer, "percentage", 100*spammer/(spammer+n_spammer))
